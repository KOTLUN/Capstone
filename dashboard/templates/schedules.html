{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Scheduling - Web ARMS</title>
    <link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
</head>
<body>
    <div class="page-wrapper">
        {% include 'structures/sidebar.html' %}
        <div class="main-content">
            <div class="content-container p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3">Teacher Scheduling</h1>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addScheduleModal">
                        Add New Schedule
                    </button>
                </div>

                <div class="row mt-4" style="margin-bottom: 20px;">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Available Sections</h5>
                            </div>
                            <div class="card-body">
                                <!-- Search and Filter -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                            <input type="text" class="form-control" id="searchSection" placeholder="Search sections...">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-text">Filter by Grade</span>
                                            <select class="form-select" id="filterGradeLevel">
                                                <option value="all" selected>All Grade Levels</option>
                                                {% for grade in grade_levels %}
                                                <option value="{{ grade }}">Grade {{ grade }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                               

                                <!-- Sections Card View -->
                                <div class="row" id="sectionsContainer">
                                    {% for section in sections %}
                                    <div class="col-md-4 section-item mb-4" data-grade="{{ section.grade_level }}">
                                        <div class="card section-card h-100">
                                            <div class="card-header {% cycle 'bg-primary' 'bg-success' 'bg-info' 'bg-warning' 'bg-danger' 'bg-secondary' %} text-white d-flex justify-content-between align-items-center">
                                                <h5 class="card-title mb-0">Grade {{ section.grade_level }}</h5>
                                                <button class="btn btn-light btn-sm view-schedule-btn" 
                                                        data-section-id="{{ section.id }}"
                                                        data-section-name="{{ section.section_id }}"
                                                        data-bs-toggle="tooltip" 
                                                        title="View Weekly Schedule">
                                                    <i class="fas fa-calendar-week"></i>
                                                </button>
                                            </div>
                                            <div class="card-body">
                                                <h6 class="card-subtitle mb-2">Section: {{ section.section_id }}</h6>
                                                <p class="card-text">
                                                    <strong>Adviser:</strong> {{ section.adviser.first_name }} {{ section.adviser.last_name }}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="col-12 text-center py-4">
                                        <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                                        <h5>No Sections Available</h5>
                                        <p class="text-muted">No sections have been created yet.</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add this after the sections card and before the Add Schedule Modal -->

                <div class="row mt-4" style="margin-bottom: 20px;">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Teacher Schedules</h5>
                            </div>
                            <div class="card-body">
                                <!-- Search and Filter -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                            <input type="text" class="form-control" id="searchTeacher" placeholder="Search teachers...">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-text">Filter by Role</span>
                                            <select class="form-select" id="filterTeacherRole">
                                                <option value="all" selected>All Teachers</option>
                                                <option value="adviser">Advisers</option>
                                                <option value="subject">Subject Teachers</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Teachers Card View -->
                                <div class="row" id="teachersContainer">
                                    {% for teacher in teachers %}
                                    <div class="col-md-4 teacher-item mb-4" 
                                         data-role="{% if teacher.sections.exists %}adviser{% else %}subject{% endif %}"
                                         data-teacher-id="{{ teacher.id }}"
                                         data-teacher-name="{{ teacher.first_name }} {{ teacher.last_name }}">
                                        <div class="card teacher-card h-100">
                                            <div class="card-header {% cycle 'bg-primary' 'bg-success' 'bg-info' 'bg-warning' 'bg-danger' 'bg-secondary' %} text-white d-flex justify-content-between align-items-center">
                                                <h5 class="card-title mb-0">{{ teacher.first_name }} {{ teacher.last_name }}</h5>
                                                <div>
                                                    <button class="btn btn-light btn-sm view-teacher-schedule-btn" 
                                                            data-teacher-id="{{ teacher.id }}"
                                                            data-teacher-name="{{ teacher.first_name }} {{ teacher.last_name }}"
                                                            data-bs-toggle="tooltip" 
                                                            title="View Weekly Schedule">
                                                        <i class="fas fa-calendar-week"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <h6 class="card-subtitle mb-2">ID: {{ teacher.teacher_id }}</h6>
                                                <p class="card-text">
                                                    <strong>Role:</strong> 
                                                    {% with role_info=teacher_roles|get_item:teacher.id %}
                                                        {% if role_info.role == 'adviser' %}
                                                            Adviser ({{ role_info.section }})
                                                        {% else %}
                                                            Subject Teacher
                                                        {% endif %}
                                                    {% endwith %}
                                                </p>
                                                <p class="card-text">
                                                    <strong>Subjects:</strong><br>
                                                    {% with teacher_subject_list=teacher_subjects|get_item:teacher.id %}
                                                        {% if teacher_subject_list %}
                                                            {% for subject in teacher_subject_list %}
                                                                <span class="badge bg-secondary me-1">{{ subject.name }}</span>
                                                            {% endfor %}
                                                        {% else %}
                                                            <span class="text-muted">No subjects assigned</span>
                                                        {% endif %}
                                                    {% endwith %}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="col-12 text-center py-4">
                                        <i class="fas fa-user-tie fa-3x text-muted mb-3"></i>
                                        <h5>No Teachers Available</h5>
                                        <p class="text-muted">No teachers have been added yet.</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Schedule Table
                <div class="card">
                    <div class="card-body">
                        <table class="table table-striped" id="scheduleTable">
                            <thead>
                                <tr>
                                    <th>Teacher</th>
                                    <th>Subject</th>
                                    <th>Grade Level</th>
                                    <th>Section</th>
                                    <th>Day</th>
                                    <th>Time</th>
                                    <th>Room</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for schedule in schedules %}
                                <tr>
                                    <td>{{ schedule.teacher_id.first_name }} {{ schedule.teacher_id.last_name }}</td>
                                    <td>{{ schedule.subject.name }}</td>
                                    <td>{{ schedule.grade_level }}</td>
                                    <td>{{ schedule.section.section_id }}</td>
                                    <td>{{ schedule.day }}</td>
                                    <td>{{ schedule.start_time|time:"H:i" }} - {{ schedule.end_time|time:"H:i" }}</td>
                                    <td>{{ schedule.room }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div> -->

                <!-- Add Schedule Modal -->
                <div class="modal fade" id="addScheduleModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">Add New Schedule</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <form id="addScheduleForm" method="POST" action="{% url 'dashboard:add_schedule' %}">
                                {% csrf_token %}
                                <div class="modal-body p-4">
                                    <div class="row g-4">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="teacher" class="form-label fw-bold">Teacher</label>
                                                <select class="form-select shadow-sm" id="teacher" name="teacher_id" required>
                                                    <option value="">Select Teacher</option>
                                                    {% for teacher in teachers %}
                                                    <option value="{{ teacher.id }}">{{ teacher.first_name }} {{ teacher.last_name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="subject" class="form-label fw-bold">Subject</label>
                                                <select class="form-select shadow-sm" id="subject" name="subject" required>
                                                    <option value="">Select Subject</option>
                                                    {% for subject in subjects %}
                                                    <option value="{{ subject.id }}">{{ subject.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="gradeLevel" class="form-label fw-bold">Grade Level</label>
                                                <select class="form-select shadow-sm" id="gradeLevel" name="grade_level" required>
                                                    <option value="">Select Grade Level</option>
                                                    <option value="7">Grade 7</option>
                                                    <option value="8">Grade 8</option>
                                                    <option value="9">Grade 9</option>
                                                    <option value="10">Grade 10</option>
                                                    <option value="11">Grade 11</option>
                                                    <option value="12">Grade 12</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="section" class="form-label fw-bold">Section</label>
                                                <select class="form-select shadow-sm" id="section" name="section" required>
                                                    <option value="">Select Section</option>
                                                    {% for section in sections %}
                                                        <option value="{{ section.id }}">Grade {{ section.grade_level }} - {{ section.section_id }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-12">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Days</label>
                                                <div class="d-flex flex-wrap gap-3">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="days[]" value="Monday" id="dayMonday">
                                                        <label class="form-check-label" for="dayMonday">Monday</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="days[]" value="Tuesday" id="dayTuesday">
                                                        <label class="form-check-label" for="dayTuesday">Tuesday</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="days[]" value="Wednesday" id="dayWednesday">
                                                        <label class="form-check-label" for="dayWednesday">Wednesday</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="days[]" value="Thursday" id="dayThursday">
                                                        <label class="form-check-label" for="dayThursday">Thursday</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="days[]" value="Friday" id="dayFriday">
                                                        <label class="form-check-label" for="dayFriday">Friday</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-12">
                                            <div class="mb-3">
                                                <label for="timeSlot" class="form-label fw-bold">Time Slot</label>
                                                <select class="form-select shadow-sm" id="timeSlot" required>
                                                    <option value="">Select Time Slot</option>
                                                </select>
                                                <small class="text-muted">
                                                    <i class="fas fa-info-circle"></i> Available time slots are shown based on teacher's schedule
                                                </small>
                                            </div>
                                        </div>
                                        <input type="hidden" id="startTime" name="start_time">
                                        <input type="hidden" id="endTime" name="end_time">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="room" class="form-label fw-bold">Room</label>
                                                <input type="text" class="form-control shadow-sm" id="room" name="room" required>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer bg-light">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Add Schedule</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Add this after the schedule table card -->
                
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

    <script>
        $(document).ready(function() {
            // Initialize DataTable
            $('#scheduleTable').DataTable();

            // Grade Level change event handler
            $('#gradeLevel').change(function() {
                const gradeLevel = $(this).val();
                const sectionSelect = $('#section');
                
                sectionSelect.empty();
                sectionSelect.append('<option value="">Select Section</option>');
                
                if (gradeLevel) {
                    $.ajax({
                        url: "{% url 'dashboard:get_sections_by_grade' %}",
                        data: { grade_level: gradeLevel },
                        success: function(data) {
                            data.sections.forEach(function(section) {
                                sectionSelect.append(
                                    `<option value="${section.id}">${section.section_id}</option>`
                                );
                            });
                        }
                    });
                }
            });

            // Function to check subject availability
            function checkSubjectAvailability() {
                const teacherId = $('#teacher').val();
                const subjectId = $('#subject').val();
                const gradeLevel = $('#gradeLevel').val();
                const sectionId = $('#section').val();

                if (!teacherId || !subjectId || !gradeLevel || !sectionId) return;

                // Pick the first checked day, or default to 'Monday'
                let day = $('input[name="days[]"]:checked').first().val() || 'Monday';

                $.ajax({
                    url: "{% url 'dashboard:get_available_time_slots' %}",
                    data: {
                        teacher_id: teacherId,
                        subject: subjectId,
                        grade_level: gradeLevel,
                        section_id: sectionId,
                        day: day
                    },
                    success: function(response) {
                        // Clear any existing error messages
                        $('.subject-error').remove();
                    },
                    error: function(xhr) {
                        if (xhr.status === 400) {
                            const response = JSON.parse(xhr.responseText);
                            // Display error message
                            const errorDiv = $('<div class="alert alert-danger subject-error mt-2"></div>')
                                .text(response.error);
                            $('#subject').after(errorDiv);
                            
                            // Reset subject selection
                            $('#subject').val('');
                            
                            // Disable time slot selection
                            $('#timeSlot').prop('disabled', true);
                        }
                    }
                });
            }

            // Add change event listeners
            $('#subject, #section, #gradeLevel').change(function() {
                checkSubjectAvailability();
            });

            // Update time slots when teacher or days change
            $('#teacher').change(updateAvailableTimeSlots);
            $('input[name="days[]"]:checked').change(updateAvailableTimeSlots);

            // Handle time slot selection
            $('#timeSlot').change(function() {
                const value = $(this).val();
                if (value) {
                    const [start, end] = value.split(',');
                    $('#startTime').val(start);
                    $('#endTime').val(end);
                } else {
                    $('#startTime').val('');
                    $('#endTime').val('');
                }
            });

            // Time validation
            $('#startTime, #endTime').change(function() {
                const startTime = $('#startTime').val();
                const endTime = $('#endTime').val();
                
                if (startTime && endTime && startTime >= endTime) {
                    alert('End time must be after start time');
                    $('#endTime').val('');
                }
            });

            // Update the existing updateAvailableTimeSlots function
            function updateAvailableTimeSlots() {
                const teacherId = $('#teacher').val();
                const selectedDays = $('input[name="days[]"]:checked').map(function() {
                    return $(this).val();
                }).get();
                const sectionId = $('#section').val();
                const subjectId = $('#subject').val();
                const gradeLevel = $('#gradeLevel').val();
                const room = $('#room').val();  // Get room value

                if (!teacherId || selectedDays.length === 0 || !subjectId || !sectionId || !room) {
                    // Clear time slots if any required field is missing
                    const timeSlotSelect = $('#timeSlot');
                    timeSlotSelect.empty().append('<option value="">Select Time Slot</option>');
                    return;
                }

                // Clear and disable time slot select
                const timeSlotSelect = $('#timeSlot');
                timeSlotSelect.empty().append('<option value="">Loading available times...</option>').prop('disabled', true);

                // Get available time slots for each selected day
                const promises = selectedDays.map(day => 
                    $.get("{% url 'dashboard:get_available_time_slots' %}", {
                        teacher_id: teacherId,
                        day: day,
                        section_id: sectionId,
                        subject: subjectId,
                        grade_level: gradeLevel,
                        room: room  // Include room in the request
                    })
                );

                // Process results
                Promise.all(promises)
                    .then(results => {
                        const commonSlots = results.reduce((common, result, index) => {
                            const slots = result.available_slots || result.time_slots || [];
                            if (index === 0) return slots;
                            return common.filter(commonSlot => 
                                slots.some(slot => slot.start === commonSlot.start)
                            );
                        }, []);

                        // Update time slot select
                        timeSlotSelect.empty().append('<option value="">Select Time Slot</option>');
                        if (commonSlots.length > 0) {
                            commonSlots.forEach(slot => {
                                timeSlotSelect.append(
                                    `<option value="${slot.start},${slot.end}">${slot.display}</option>`
                                );
                            });
                        } else {
                            timeSlotSelect.append('<option value="" disabled>No available time slots</option>');
                        }
                    })
                    .finally(() => {
                        timeSlotSelect.prop('disabled', false);
                    });
            }

            // Add room change handler
            $('#room').change(function() {
                updateAvailableTimeSlots();
            });

            // Update form submission validation
            $('#addScheduleForm').submit(function(e) {
                e.preventDefault();
                
                // Validate at least one day is selected
                if ($('input[name="days[]"]:checked').length === 0) {
                    alert('Please select at least one day');
                    return false;
                }
                
                // Get selected days
                const selectedDays = [];
                $('input[name="days[]"]:checked').each(function() {
                    selectedDays.push($(this).val());
                });
                
                let successCount = 0;
                let errorCount = 0;
                let errorMessages = [];
                
                // Show loading message
                const loadingDiv = $('<div class="alert alert-info mt-3">Adding schedules...</div>');
                $(this).append(loadingDiv);
                
                // Process each day
                selectedDays.forEach(function(day) {
                    // Always extract start and end time from the selected time slot for each day
                    const timeSlotValue = $('#timeSlot').val();
                    let startTime = '';
                    let endTime = '';
                    if (timeSlotValue) {
                        [startTime, endTime] = timeSlotValue.split(',');
                    }
                    const formData = new FormData();
                    formData.append('teacher', $('#teacher').val());
                    formData.append('subject', $('#subject').val());
                    formData.append('grade_level', $('#gradeLevel').val());
                    formData.append('section', $('#section').val());
                    formData.append('day', day);
                    formData.append('start_time', startTime);
                    formData.append('end_time', endTime);
                    formData.append('room', $('#room').val());
                    formData.append('csrfmiddlewaretoken', $('[name=csrfmiddlewaretoken]').val());
                    
                    $.ajax({
                        url: "{% url 'dashboard:add_schedule' %}",
                        method: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function(response) {
                            if (response.success) {
                                successCount++;
                            } else {
                                errorCount++;
                                errorMessages.push(response.message);
                            }
                            checkCompletion();
                        },
                        error: function(xhr, status, error) {
                            errorCount++;
                            errorMessages.push(error);
                            checkCompletion();
                        }
                    });
                });
                
                function checkCompletion() {
                    if (successCount + errorCount === selectedDays.length) {
                        loadingDiv.remove();
                        if (errorCount === 0) {
                            toastr.success('All schedules added successfully!');
                            $('#addScheduleModal').modal('hide');
                            setTimeout(function() {
                                location.reload();
                            }, 1200);
                        } else {
                            const errorMessage = `Added ${successCount} schedules, but ${errorCount} failed.\n\nErrors:\n${errorMessages.join('\n')}`;
                            toastr.error(errorMessage.replace(/\n/g, '<br>'));
                        }
                    }
                }
            });

            // Section search and filter functionality
            const searchSection = document.getElementById('searchSection');
            const filterGradeLevel = document.getElementById('filterGradeLevel');
            const sectionItems = document.querySelectorAll('.section-item');

            function filterSections() {
                const searchTerm = searchSection.value.toLowerCase();
                const gradeFilter = filterGradeLevel.value;
                
                sectionItems.forEach(item => {
                    const sectionText = item.textContent.toLowerCase();
                    const gradeLevel = item.getAttribute('data-grade');
                    
                    const matchesSearch = sectionText.includes(searchTerm);
                    const matchesGrade = gradeFilter === 'all' || gradeLevel === gradeFilter;
                    
                    item.style.display = matchesSearch && matchesGrade ? '' : 'none';
                });
            }

            if (searchSection) {
                searchSection.addEventListener('input', filterSections);
            }
            
            if (filterGradeLevel) {
                filterGradeLevel.addEventListener('change', filterSections);
            }

            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            });

            // Handle view schedule button click
            $('.view-schedule-btn').click(function(e) {
                e.preventDefault();
                const sectionId = $(this).data('section-id');
                const sectionName = $(this).data('section-name');
                
                // Show loading state
                $('#weeklyScheduleContent').html('<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>');
                $('#weeklyScheduleModal').modal('show');

                // Fetch schedule data
                $.ajax({
                    url: "{% url 'dashboard:get_section_schedule' %}",
                    data: { section_id: sectionId },
                    success: function(response) {
                        if (response.success) {
                            // Create calendar grid
                            let html = '<div class="schedule-calendar">';
                            
                            // Create time slots (7:00 AM to 5:00 PM)
                            const timeSlots = [];
                            for (let hour = 7; hour <= 17; hour++) {
                                timeSlots.push({
                                    start: `${hour.toString().padStart(2, '0')}:00`,
                                    end: `${(hour + 1).toString().padStart(2, '0')}:00`
                                });
                            }

                            // Group schedules by day
                            const schedulesByDay = {
                                'Monday': [],
                                'Tuesday': [],
                                'Wednesday': [],
                                'Thursday': [],
                                'Friday': []
                            };

                            // Organize schedules by day
                            response.schedules.forEach(schedule => {
                                if (!schedulesByDay[schedule.day]) {
                                    schedulesByDay[schedule.day] = [];
                                }
                                schedulesByDay[schedule.day].push(schedule);
                            });

                            // Create header row
                            html += '<div class="calendar-row header">';
                            html += '<div class="time-slot">Time</div>';
                            Object.keys(schedulesByDay).forEach(day => {
                                html += `<div class="day-header">${day}</div>`;
                            });
                            html += '</div>';

                            // Create schedule grid
                            timeSlots.forEach(timeSlot => {
                                html += '<div class="calendar-row">';
                                // Format time display
                                const startTime = new Date(`2000-01-01 ${timeSlot.start}`);
                                const endTime = new Date(`2000-01-01 ${timeSlot.end}`);
                                const timeDisplay = `${startTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })} - ${endTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}`;
                                html += `<div class="time-slot">${timeDisplay}</div>`;
                                
                                Object.keys(schedulesByDay).forEach(day => {
                                    const daySchedules = schedulesByDay[day] || [];
                                    const matchingSchedule = daySchedules.find(schedule => 
                                        schedule.start_time === timeSlot.start && 
                                        schedule.end_time === timeSlot.end
                                    );

                                    if (matchingSchedule) {
                                        html += `<div class="calendar-cell schedule-slot">
                                            <div class="subject">${matchingSchedule.subject_name}</div>
                                            <div class="teacher">${matchingSchedule.teacher_name}</div>
                                            <div class="room">${matchingSchedule.room}</div>
                                        </div>`;
                                    } else {
                                        html += '<div class="calendar-cell empty-slot"></div>';
                                    }
                                });
                                
                                html += '</div>';
                            });

                            html += '</div>';
                            $('#weeklyScheduleContent').html(html);
                            $('.modal-title').text(`Weekly Schedule - ${sectionName}`);
                        } else {
                            $('#weeklyScheduleContent').html(`<div class="alert alert-danger">${response.message}</div>`);
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#weeklyScheduleContent').html(`<div class="alert alert-danger">Error loading schedule: ${error}</div>`);
                    }
                });
            });

            // Teacher search and filter functionality
            const searchTeacher = document.getElementById('searchTeacher');
            const filterTeacherRole = document.getElementById('filterTeacherRole');
            const teacherItems = document.querySelectorAll('.teacher-item');

            function filterTeachers() {
                const searchTerm = searchTeacher.value.toLowerCase();
                const roleFilter = filterTeacherRole.value;
                
                teacherItems.forEach(item => {
                    const teacherText = item.textContent.toLowerCase();
                    const teacherRole = item.getAttribute('data-role');
                    
                    const matchesSearch = teacherText.includes(searchTerm);
                    const matchesRole = roleFilter === 'all' || teacherRole === roleFilter;
                    
                    item.style.display = matchesSearch && matchesRole ? '' : 'none';
                });
            }

            if (searchTeacher) {
                searchTeacher.addEventListener('input', filterTeachers);
            }
            
            if (filterTeacherRole) {
                filterTeacherRole.addEventListener('change', filterTeachers);
            }

            // Handle view teacher schedule button click
            $('.view-teacher-schedule-btn').click(function(e) {
                e.preventDefault();
                const teacherId = $(this).data('teacher-id');
                const teacherName = $(this).data('teacher-name');
                
                // Show loading state
                $('#weeklyScheduleContent').html('<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>');
                $('#weeklyScheduleModal').modal('show');

                // Fetch teacher schedule data
                $.ajax({
                    url: "{% url 'dashboard:get_teacher_schedule' %}",
                    data: { teacher_id: teacherId },
                    success: function(response) {
                        if (response.success) {
                            // Create calendar grid
                            let html = '<div class="schedule-calendar">';
                            
                            // Create time slots (7:00 AM to 5:00 PM)
                            const timeSlots = [];
                            for (let hour = 7; hour <= 17; hour++) {
                                timeSlots.push({
                                    start: `${hour.toString().padStart(2, '0')}:00`,
                                    end: `${(hour + 1).toString().padStart(2, '0')}:00`
                                });
                            }

                            // Group schedules by day
                            const schedulesByDay = {
                                'Monday': [],
                                'Tuesday': [],
                                'Wednesday': [],
                                'Thursday': [],
                                'Friday': []
                            };

                            // Organize schedules by day
                            response.schedules.forEach(schedule => {
                                if (!schedulesByDay[schedule.day]) {
                                    schedulesByDay[schedule.day] = [];
                                }
                                schedulesByDay[schedule.day].push(schedule);
                            });

                            // Create header row
                            html += '<div class="calendar-row header">';
                            html += '<div class="time-slot">Time</div>';
                            Object.keys(schedulesByDay).forEach(day => {
                                html += `<div class="day-header">${day}</div>`;
                            });
                            html += '</div>';

                            // Create schedule grid
                            timeSlots.forEach(timeSlot => {
                                html += '<div class="calendar-row">';
                                // Format time display
                                const startTime = new Date(`2000-01-01 ${timeSlot.start}`);
                                const endTime = new Date(`2000-01-01 ${timeSlot.end}`);
                                const timeDisplay = `${startTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })} - ${endTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}`;
                                html += `<div class="time-slot">${timeDisplay}</div>`;
                                
                                Object.keys(schedulesByDay).forEach(day => {
                                    const daySchedules = schedulesByDay[day] || [];
                                    const matchingSchedule = daySchedules.find(schedule => 
                                        schedule.start_time === timeSlot.start && 
                                        schedule.end_time === timeSlot.end
                                    );

                                    if (matchingSchedule) {
                                        html += `<div class="calendar-cell schedule-slot">
                                            <div class="subject">${matchingSchedule.subject_name}</div>
                                            <div class="section">${matchingSchedule.section_name}</div>
                                            <div class="room">${matchingSchedule.room}</div>
                                        </div>`;
                                    } else {
                                        html += '<div class="calendar-cell empty-slot"></div>';
                                    }
                                });
                                
                                html += '</div>';
                            });

                            html += '</div>';
                            $('#weeklyScheduleContent').html(html);
                            $('.modal-title').text(`Weekly Schedule - ${teacherName}`);
                        } else {
                            $('#weeklyScheduleContent').html(`<div class="alert alert-danger">${response.message}</div>`);
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#weeklyScheduleContent').html(`<div class="alert alert-danger">Error loading schedule: ${error}</div>`);
                    }
                });
            });
        });
    </script>

    <!-- Add these styles -->
    <style>
        body {
            background-color: #f8f9e3;
            font-family: 'Poppins', sans-serif;
        }
        
        .page-wrapper {
            display: flex;
            min-height: 100vh;
        }
        
        .main-content {
            margin-left: 250px;
            flex: 1;
            padding: 20px;
            background: #f8f9e3;
        }

        .card {
            border-radius: 0.75rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            transition: all 0.3s ease;
            border: none;
        }

        .card:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            transform: translateY(-3px);
        }

        .table-responsive {
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .btn {
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
        }

        .btn-group .btn {
            border-radius: 0.375rem;
        }

        .form-control, .form-select {
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
        }

        .badge {
            padding: 0.5em 0.75em;
            font-weight: 500;
        }

        .modal-content {
            border-radius: 0.75rem;
            border: none;
        }

        .modal-header {
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
        }

        .content-container {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        .section-card {
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .section-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .list-group-item {
            border-left: none;
            border-right: none;
        }
        
        .list-group-item:first-child {
            border-top: none;
        }
        
        .list-group-item:last-child {
            border-bottom: none;
        }

        .view-schedule-btn {
            padding: 0.25rem 0.5rem;
            line-height: 1;
        }
        
        .view-schedule-btn:hover {
            background-color: rgba(255, 255, 255, 0.9);
        }
        
        .schedule-item {
            font-size: 0.85rem;
            height: 100%;
        }

        .teacher-card {
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .teacher-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .view-teacher-schedule-btn {
            padding: 0.25rem 0.5rem;
            line-height: 1;
        }
        
        .view-teacher-schedule-btn:hover {
            background-color: rgba(255, 255, 255, 0.9);
        }

        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
                width: 100%;
            }
        }

        /* Calendar Grid Styles */
        .schedule-calendar {
            display: flex;
            flex-direction: column;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            overflow: hidden;
            margin: 1rem 0;
        }

        .calendar-header {
            display: grid;
            grid-template-columns: 100px repeat(5, 1fr);
            background-color: #0d6efd;
            color: white;
            font-weight: 600;
        }

        .time-header, .day-header {
            padding: 0.75rem;
            text-align: center;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .calendar-row {
            display: grid;
            grid-template-columns: 100px repeat(5, 1fr);
            border-bottom: 1px solid #dee2e6;
        }

        .calendar-row:last-child {
            border-bottom: none;
        }

        .time-slot {
            padding: 0.75rem;
            text-align: center;
            background-color: #f8f9fa;
            border-right: 1px solid #dee2e6;
            font-size: 0.875rem;
            color: #6c757d;
        }

        .calendar-cell {
            padding: 0.5rem;
            border-right: 1px solid #dee2e6;
            min-height: 80px;
        }

        .calendar-cell:last-child {
            border-right: none;
        }

        .empty-slot {
            background-color: #f8f9fa;
        }

        .schedule-slot {
            background-color: #e9ecef;
            border-radius: 0.25rem;
            padding: 0.5rem;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .schedule-slot .subject {
            font-weight: 600;
            color: #0d6efd;
            margin-bottom: 0.25rem;
        }

        .schedule-slot .teacher,
        .schedule-slot .section {
            font-size: 0.75rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }

        .schedule-slot .room {
            font-size: 0.75rem;
            color: #6c757d;
        }

        @media (max-width: 992px) {
            .schedule-calendar {
                font-size: 0.875rem;
            }
            
            .time-slot {
                padding: 0.5rem;
            }
            
            .calendar-cell {
                padding: 0.25rem;
            }
        }

        @media (max-width: 768px) {
            .schedule-calendar {
                font-size: 0.75rem;
            }
            
            .time-slot {
                padding: 0.25rem;
            }
            
            .calendar-cell {
                min-height: 60px;
            }
        }
    </style>

    <!-- Weekly Schedule Modal -->
    <div class="modal fade" id="weeklyScheduleModal" tabindex="-1" aria-labelledby="weeklyScheduleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="weeklyScheduleModalLabel">Weekly Schedule</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="weeklyScheduleContent">
                        <!-- Schedule will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    $(document).ready(function() {
        // Print button click handler
        $('#printScheduleBtn').click(function() {
            const content = document.getElementById('weeklyScheduleContent');
            const title = document.querySelector('.modal-title').textContent;
            
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${title}</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
                    <style>
                        @page {
                            size: A4;
                            margin: 1.5cm;
                        }
                        @media print {
                            body {
                                margin: 0;
                                padding: 0;
                                font-size: 12px;
                            }
                            .container {
                                width: 100% !important;
                                max-width: none !important;
                                padding: 0 !important;
                                margin: 0 !important;
                            }
                            .table {
                                width: 100% !important;
                                margin: 0 !important;
                                border: 1px solid #000 !important;
                            }
                            .table th, .table td {
                                border: 1px solid #000 !important;
                                padding: 4px 8px !important;
                            }
                            .schedule-item {
                                page-break-inside: avoid;
                                border: none !important;
                            }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            line-height: 1.4;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 20px;
                            border-bottom: 2px solid #000;
                            padding-bottom: 10px;
                        }
                        .header h2 {
                            font-size: 16px;
                            font-weight: bold;
                            margin-bottom: 5px;
                        }
                        .header p {
                            font-size: 12px;
                            margin: 0;
                        }
                        .table {
                            border-collapse: collapse;
                            width: 100%;
                        }
                        .table th {
                            background-color: #f8f9fa !important;
                            font-weight: bold;
                            text-align: center;
                            vertical-align: middle;
                            font-size: 12px;
                        }
                        .table td {
                            vertical-align: top;
                            padding: 4px 8px;
                            font-size: 11px;
                        }
                        .schedule-item {
                            background-color: #f8f9fa;
                            padding: 4px;
                            margin: 1px;
                        }
                        .schedule-item strong {
                            display: block;
                            margin-bottom: 2px;
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <h2>${title}</h2>
                            <p>Generated on ${new Date().toLocaleDateString()}</p>
                        </div>
                        ${content.innerHTML}
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Wait for resources to load then print
            printWindow.onload = function() {
                setTimeout(function() {
                    printWindow.print();
                    setTimeout(function() {
                        printWindow.close();
                    }, 500);
                }, 1000);
            };
        });
    });
    </script>

    <script>
    $(document).ready(function() {
        toastr.options = {
            "closeButton": true,
            "progressBar": true,
            "positionClass": "toast-top-right",
            "timeOut": "3000",
            "zIndex": 99999
        };
    });
    </script>
</body>
</html>
